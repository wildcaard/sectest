from dataclasses import dataclass, field
from enum import Enum
from typing import Optional
import uuid
from datetime import datetime


class Severity(Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "informational"


class VulnerabilityCategory(Enum):
    INJECTION = "Injection"
    BROKEN_AUTH = "Broken Authentication"
    SENSITIVE_DATA = "Sensitive Data Exposure"
    XXE = "XML External Entities"
    BROKEN_ACCESS = "Broken Access Control"
    SECURITY_MISCONFIG = "Security Misconfiguration"
    XSS = "Cross-Site Scripting"
    INSECURE_DESERIALIZATION = "Insecure Deserialization"
    VULNERABLE_COMPONENTS = "Using Components with Known Vulnerabilities"
    INSUFFICIENT_LOGGING = "Insufficient Logging & Monitoring"
    SSRF = "Server-Side Request Forgery"
    CSRF = "Cross-Site Request Forgery"


@dataclass
class Vulnerability:
    title: str
    severity: Severity
    category: VulnerabilityCategory
    description: str
    evidence: str
    url: str
    id: str = field(default_factory=lambda: str(uuid.uuid4())[:8])
    remediation: str = ""
    cvss_score: float = 0.0
    cwe_id: str = ""
    owasp_category: str = ""
    references: list[str] = field(default_factory=list)
    false_positive_likelihood: str = "low"
    ai_analysis: str = ""
    ai_fix_suggestion: str = ""
    human_verified: bool = False
    human_notes: str = ""
    scanner_name: str = ""
    discovered_at: str = field(default_factory=lambda: datetime.now().isoformat())

    def to_dict(self) -> dict:
        return {
            "id": self.id,
            "title": self.title,
            "severity": self.severity.value,
            "category": self.category.value,
            "description": self.description,
            "evidence": self.evidence,
            "url": self.url,
            "remediation": self.remediation,
            "cvss_score": self.cvss_score,
            "cwe_id": self.cwe_id,
            "owasp_category": self.owasp_category,
            "references": self.references,
            "false_positive_likelihood": self.false_positive_likelihood,
            "ai_analysis": self.ai_analysis,
            "ai_fix_suggestion": self.ai_fix_suggestion,
            "human_verified": self.human_verified,
            "human_notes": self.human_notes,
            "scanner_name": self.scanner_name,
            "discovered_at": self.discovered_at,
        }
